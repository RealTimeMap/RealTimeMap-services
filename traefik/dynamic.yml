http:
  routers:
    # Публичные эндпоинты авторизации (только login и register доступны извне)
    auth-public:
      rule: "Host(`realtimemap.ru`) && (Path(`/api/v1/auth/login`) || Path(`/api/v1/auth/register`) || Path(`/api/v1/auth/logout`) || Path(`/admin`) || Path(`/api/v1/auth/google`))"
      entryPoints:
        - web
        - websecure
      service: auth-service
      priority: 100
      tls: {}

  services:
    # Auth service (api/v1) - доступен только для /login, /register и ForwardAuth
    auth-service:
      loadBalancer:
        servers:
          - url: "http://realtime-map-backend:8001"

  middlewares:
    # ForwardAuth middleware для проверки Bearer токена
    # auth-service вернет 401 если токен невалиден
    # Traefik автоматически проксирует эту ошибку клиенту
    auth-check:
      forwardAuth:
        address: "http://realtime-map-backend:8001/api/v1/auth/token-validate"
        authResponseHeaders:
          - "X-User-Id"
          - "X-User-Name"
          - "X-User-Ban"
          - "X-User-Admin"
        authRequestHeaders:
          - "Authorization"
        trustForwardHeader: false

tls:
  certificates:
    - certFile: /certs/fullchain.pem
      keyFile: /certs/privkey.pem

  stores:
    default:
      defaultCertificate:
        certFile: /certs/fullchain.pem
        keyFile: /certs/privkey.pem
