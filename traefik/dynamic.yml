http:
  routers:
    auth-public:
      rule: "Host(`realtimemap.ru`) && (PathPrefix(`/api/v2/auth/`) || PathPrefix(`/api/v2/user/`) || PathPrefix(`/docs/`) || PathPrefix(`/admin/`) || PathPrefix(`/static/`))"
      entryPoints:
        - websecure
      service: auth-service
      priority: 100
      tls: {}

  services:
    auth-service:
      loadBalancer:
        servers:
          - url: "http://realtime-map-backend:8001"

  middlewares:
    # CORS headers middleware
    cors-headers:
      headers:
        accessControlAllowMethods:
          - "GET"
          - "POST"
          - "PUT"
          - "PATCH"
          - "DELETE"
          - "HEAD"
          - "OPTIONS"
        accessControlAllowOriginList:
          - "https://real-time-map-frontend.vercel.app"
          - "https://trip-scheduler.ru"
          - "https://realtimemap.ru"
          - "http://localhost:5173"
          - "http://localhost:1420"
        accessControlAllowHeaders:
          - "Origin"
          - "Content-Type"
          - "Accept"
          - "Authorization"
          - "X-User-Id"
          - "X-User-Name"
          - "X-User-Ban"
          - "X-User-Admin"
        accessControlExposeHeaders:
          - "Content-Length"
        accessControlAllowCredentials: true
        accessControlMaxAge: 43200

    # ForwardAuth middleware для проверки Bearer токена
    # auth-service вернет 401 если токен невалиден
    # Traefik автоматически проксирует эту ошибку клиенту
    auth-check:
      forwardAuth:
        address: "http://realtime-map-backend:8001/api/v2/auth/token-validate"
        authResponseHeaders:
          - "X-User-Id"
          - "X-User-Name"
          - "X-User-Ban"
          - "X-User-Admin"
        authRequestHeaders:
          - "Authorization"

tls:
  certificates:
    - certFile: /certs/fullchain.pem
      keyFile: /certs/privkey.pem

  stores:
    default:
      defaultCertificate:
        certFile: /certs/fullchain.pem
        keyFile: /certs/privkey.pem